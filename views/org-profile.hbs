<head>
    <script src="/js/jquery-3.3.1.js"></script>
    <script src="/js/extract_tags_render.js"></script>
    <script src="/js/map_char.js"></script>
    <script src="/js/trends.js"></script>
    <script src="/js/append.js"></script>
    <script src="/js/search.js"></script>
    <script src="/uikit/js/uikit.js"></script>
    <script src="/js/conversation.js"></script>
    <link rel="stylesheet" href="/uikit/css/uikit.css">
    <link rel="stylesheet" href="/css/org-profile.css">
    <link rel="stylesheet" href="/css/messages.css">
    <link rel="stylesheet" href="/css/general.css">
    <link rel="stylesheet" href="/css/search.css">
    <title>{{name}} | Town Hall</title>
</head>
<body>
    <section class="sidebar">
        <div class="avatar">
            <img src="{{logo}}" alt="{{username}}'s Avatar" class="avatar-img"><br><br>
            {{name}}<br><br>
            @{{username}} <br><br>
            <div>
                Unique followers: <a href="/followers/organisations/{{username}}">{{followersNo}}</a>
                <br><br>
                <a href="/settings/{{username}}">Settings</a>
                {{!-- Other stuff could go here --}}
            </div>
        </div>
    </section>
    <section class="main">
        <div class="errDiv">
            <div class="errorDiv" id="errorDiv"></div>
        </div>
        <div class="tabs">
            <div id="beats" class="tab active">From Your Journalists</div>
            <div id="messaging" class="tab">Your Messaging</div>
            <div id="journalists" class="tab">Your Journalists</div>
        </div>
        <form action="javascript:search();" id="search" autocomplete="off" method="get">
            <input type="search" maxlength="100" name="term" class="search br" id="searchBox" placeholder="Search Town Hall">
            <div id="suggs" class="searchSuggs hidden">
                <div id="searchSugg" class="searchSugg">

                </div>
            </div>
        </form>
        <div id="notif" class="notif">{{notif}}</div>
        <section id="b-content" class="tab-content">
            {{#if j_msgs}}
            {{#each j_msgs}}
            {{>messages}}
            {{/each}}
            {{else}}
            <div id="no-prior" class="center grey">There are no posts from your Journalists</div>
            {{/if}}
        </section>
        <section id="m-content" class="tab-content hidden">
            <div class="postDiv">
                <form action="/messages/o" method="post">
                    <textarea id="post" maxlength="360" class="post" placeholder="Type post"></textarea>
                </form>
            </div>
            <div class="int-recs">
                {{!-- Use a pre-populated select for the beats --}}
                {{!-- int-recs: intended recepients --}}
            </div>
            <div class="postAcc">
                <div class="center grey"><span id="charCount">0</span>/360 characters</div>
                <div class="right">
                    <button id="postBtn" class="postBtn">Post</button>
                </div>
            </div>
            <br><br>
            <div class="prevM">
                <div class="posts" id="messagesDiv">
                    {{#if messages}}
                    {{#each messages}}
                    {{>messages}}
                    {{/each}}
                    {{else}}
                    <div id="no-prior" class="center grey">You have no prior posts</div>
                    {{/if}}
                    {{>modal}}
                </div>
            </div>
        </section>
        <section id="j-content" class="tab-content hidden">
            <div class="center emp-heading" id="j-reqs-emp"></div>
            <div class="j-reqs">
                {{#if pending_reqs}}
                <h3 class="center">Journalist Requests</h3>
                <table class="j-table">
                <tbody>
                    {{#each pending_reqs}}
                    <tr class="j-tr" id="j-{{username}}">
                        <td class="j-td"><a href="/profile/{{username}}">{{f_name}} {{l_name}}</a></td>
                        <td class="j-td">@{{username}}</td>
                        <td class="j-td"><img class="btn-img" onclick="location.assign('/organisations/j-requests/accept/{{../username}}/{{username}}')" src="/img/img-1/success.png" title="Accept" alt="Accept"></td>
                        <td class="j-td"><img class="btn-img" onclick="decline('{{username}}', 'j-{{username}}');" src="/img/img-1/error.png" title="Decline" alt="Decline"><td>
                    </tr>
                    {{/each}}
                </tbody>
                </table>
                {{/if}}
            </div>
            <div class="center emp-heading" id="j-text-emp"></div>
            <div class="journos">
                {{#each journos}}
                <div id="j-text" class="journo">
                    <figure class="javatar center">
                        <img src="/{{avatar}}" alt="{{f_name}}'s Avatar'">
                        <figcaption><h4><a href="/profile/{{username}}">{{f_name}} {{l_name}}</a></h4></figcaption>
                    </figure>
                    <div class="j-stats">
                        <p>Followers: <a href="/followers/j/{{username}}">{{followersNo}}</a></p>
                    </div>
                </div>
                {{/each}}
            </div>
        </section>
        <footer>
            <a href="/logout/o">Log out</a>
        </footer>
    </section>
    <section class="right-sect">
        <section class="tabBar">
            <div class="center" id="rightContent">
                <h4><a href="javascript:void();" title="Click to view more">Trending Now</a></h4>
                <div id="tr-err"></div>
                <div class="trends" id="trends">
                    
                </div>
            </div>
        </section>
    </section>
    <script>
        //tab switching
        let tabs = document.getElementsByClassName('tab');
        let content = document.getElementsByClassName('tab-content');
        function switchTab (num){
            for(let i=0; i<tabs.length; i++){
                tabs[i].className = 'tab';
                content[i].classList += ' hidden';
            }
            tabs[num].classList += ' active';
            content[num].className = 'tab-content';
        }
        $('#beats').on('click', ()=>{
            switchTab(0);
        });
        $('#messaging').on('click', ()=>{
            switchTab(1);
        });
        $('#journalists').on('click', ()=>{
            switchTab(2);
        });

        //set notif
        function setNotif(content){
            setErr(content);
        }

        //message counter
        $('#post').on('input', ()=>{
            let num = $('#post').val().length;
            document.getElementById('charCount').innerText = num;
        });

        //dealing with j's, imp a confirmation

        function decline(j_username, _id_){
            $.ajax({
                url: '/organisations/j-requests/decline/{{username}}/'+j_username,
                method: 'GET',
                success: (j_name)=>{
                    document.getElementById(_id_).classList += ' hidden';
                    setErr("Journalist: " + j_name + " rejected");
                },
                error: ()=>{
                    //do other stuff: notify about conn
                    setErr("An error occured. Please try again");
                }
            });
        }

        //send message
        $('#postBtn').on('click', (event)=>{
            let wsp = /^\s*$/;
            event.preventDefault();
            let text = document.getElementById('post').value;

            if(!wsp.test(text)){
                //text is populated
                let priorP = document.getElementById('no-prior');
                let isEmpty = true;
                if(priorP){
                    if(!wsp.test(priorP.textContent)){
                        isEmpty = false;
                    }
                }
                $.ajax({
                    url: '/messages/o',
                    method: 'POST',
                    data: {mBody: text, recepients: 'all'},
                    error: ()=>{
                        setErr("An error occured trying to send your message. Please check your connection and try again");
                    },
                    success: (data)=>{
                        document.getElementById('post').value = '';
                        document.getElementById('charCount').innerText = 0;
                        appendMessage(data.message, data.originator);
                        if(!isEmpty){
                            priorP.textContent = '';
                        }
                    }
                });
            }
        });

        fullSearch();
        reqTrends();
        clearNotif();
        {{!-- $('#messaging').click(); --}}
    </script>
</body>